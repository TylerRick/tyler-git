#!/bin/bash

# From https://chatgpt.com/c/6801c30b-6830-800b-a846-a43228b7e71e

echo "Detecting merge commits with manual conflict resolution..."

merge_commits=$(git rev-list --merges HEAD)

for commit in $merge_commits; do
    # Get the two parents of the merge commit
    parents=($(git rev-list --parents -n 1 $commit))

    # Skip if not a two-parent merge
    if [ "${#parents[@]}" -ne 3 ]; then
        continue
    fi

    echo "===================================================================================================="
    #echo "Checking $commit"
    git log-oneline -1 $commit
    git show $commit | head

    p1=${parents[1]}
    p2=${parents[2]}

    # Get merge base
    base=$(git merge-base $p1 $p2)

    # Compare actual merge commit with auto-generated merge tree
    #git merge-tree $base $p1 $p2 | less
    diff_output=$(git diff --exit-code $commit $(git merge-tree $base $p1 $p2 | git hash-object -t tree --stdin -w 2>/dev/null))
    echo "$diff_output" | head

    if [ $? -ne 0 ]; then
        echo "⚠️  Likely manual merge at $commit"
        git log -1 --format="%h %s" $commit
        exit
    fi
done

echo "Done."

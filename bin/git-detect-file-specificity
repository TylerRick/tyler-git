#!/usr/bin/env bash

# Usage: git-detect-file-specificity <path>

# Unlike git-get-file-specificity, which _only_ reads what has previously been recorded, this
# actually tries to do some detection, and checks whether what has been recorded matches.

file="$1"
if ! [ -f "$file" ]; then
  echo >&2 "$file: Does not exist"
fi

recorded=$(git-get-file-specificity "$file")
if .local/bin/git-detect-is-file-specific "$file" >/dev/null; then
  detected_specific=true
else
  detected_specific=false
fi

_red() { printf "\e[31m%s\e[0m\n" "$*"; }

confirm_loop() {
  prompt="$1"; shift
  while true; do
    read -p "$prompt [s]specific/[m]ixed/[c]ommon [v]iew/[n]no? " ans
    case "$ans" in
      [sS]) echo specific; return ;;
      [mM]) echo mixed;    return ;;
      [cC]) echo common;   return ;;
      [vV]) ${VISUAL:-${EDITOR:-vi}} "$file" ;;
      [nN])                return ;;
      *) echo "Please enter a valid option." ;;
    esac
  done
}

if [[ -z "$recorded" && "$detected_specific" == true ]]; then
  echo "$file: detected_specific=$detected_specific but no specificity recorded yet."
  choice=$(confirm_loop "Mark as specific?")
  if [[ "$choice" != none ]]; then
    git-set-file-specificity "$file" "$choice"
    echo "Recorded $file as $choice."
  fi
  exit 0
fi

# any discrepancy?
# If classified as specific/mixed, then detection script should have detected a "specific" keyword.
if [[ "$recorded" == common && "$detected_specific" == true ]] \
 || ([[ "$recorded" =~ ^(specific|mixed)$ ]] && [[ "$detected_specific" == false ]]); then
  _red "$file: Discrepancy! recorded=$recorded, but detected_specific=$detected_specific" >&2 
  choice=$(confirm_loop "Override classification for this file? (You may need to update your detection script if it failed to detect a specific/mixed file.)")
  if [[ "$choice" != none ]]; then
    git-set-file-specificity "$file" "$choice"
    echo "Updated $file â†’ $choice."
  fi
  exit 0
fi

# no discrepancy; detected already agrees with recorded
echo "$file: Recorded as $recorded; detected_specific=$detected_specific => agreement"
exit 0

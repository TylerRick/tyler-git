#!/usr/bin/env bash
# git-get-file-specificity <file>
#   outputs: common, specific, mixed, or nothing

file="$1"
dir=".git/file_specificity"

_read_patterns() {
  # Strip comments, trim whitespace, skip blank lines
  sed -e 's/#.*//' -e '/^[[:space:]]*$/d' "$1"
}

debug() {
  echo "[DEBUG] $*" >&2
}

# try common & specific first
for type in common specific; do
  pathfile="$dir/$type"
  debug "Loading $pathfile"
  _read_patterns "$pathfile" | while IFS= read -r pat; do
    debug "  $type pattern: '$pat'"
    if [[ "$pat" == */ ]]; then
      # directory prefix match
      if [[ "$file" == "${pat}"* ]]; then
        echo "$type"
        exit 0
      fi
    else
      # exact glob match
      if [[ "$file" == $pat ]]; then
        echo "$type"
        exit 0
      fi
    fi
  done
done

# now mixed (same format: path + optional comment stripped)
pathfile="$dir/mixed"
debug "Loading $pathfile"
_read_patterns "$pathfile" | while IFS= read -r pat; do
  debug "  mixed pattern: '$pat'"
  if [[ "$pat" == */ ]]; then
    if [[ "$file" == "${pat}"* ]]; then
      echo mixed
      exit 0
    fi
  else
    if [[ "$file" == $pat ]]; then
      echo mixed
      exit 0
    fi
  fi
done

# nothing matched
exit 0

